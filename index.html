<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>FinFlow</title>
  <link rel="stylesheet" href="app.css" />
  <link rel="stylesheet" href="styles/components/nav.css" />
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#000000" />
  <link rel="apple-touch-icon" sizes="180x180" href="./images/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="icon" type="image/png" sizes="192x192" href="./images/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./images/icon-512.png" />
</head>

<body>
  
<script>
(function () {
  if (window.__ffCrashOverlayInstalled) return;
  window.__ffCrashOverlayInstalled = true;

  function esc(s){ try { return String(s).replace(/[&<>"]/g,function(c){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]);}); } catch(e){ return ''+s; } }

  var overlay, pre, meta, btnCopy, btnClose;
  var logs = [];
  function ensureOverlay(){
    if (overlay) return;
    overlay = document.createElement('div');
    overlay.id = 'ff-crash-overlay';
    overlay.style.cssText = [
      'position:fixed','inset:0','z-index:2147483647','background:rgba(0,0,0,0.92)',
      'color:#fff','font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif',
      'padding:16px','box-sizing:border-box','display:none'
    ].join(';');

    var card = document.createElement('div');
    card.style.cssText = [
      'max-width:900px','margin:0 auto','background:rgba(255,255,255,0.06)',
      'border:1px solid rgba(255,255,255,0.14)','border-radius:16px','padding:14px',
      'box-shadow:0 20px 60px rgba(0,0,0,0.55)'
    ].join(';');

    var h = document.createElement('div');
    h.style.cssText = 'display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;';
    var title = document.createElement('div');
    title.style.cssText = 'font-size:16px;font-weight:700;letter-spacing:0.2px;';
    title.textContent = 'FinFlow crash log (iPhone)';

    var actions = document.createElement('div');
    actions.style.cssText = 'display:flex;gap:8px;align-items:center;';

    btnCopy = document.createElement('button');
    btnCopy.type='button';
    btnCopy.textContent='Copy';
    btnCopy.style.cssText='appearance:none;border:0;border-radius:10px;padding:8px 10px;background:#2f7cf6;color:#fff;font-weight:700;';

    btnClose = document.createElement('button');
    btnClose.type='button';
    btnClose.textContent='Close';
    btnClose.style.cssText='appearance:none;border:0;border-radius:10px;padding:8px 10px;background:rgba(255,255,255,0.16);color:#fff;font-weight:700;';

    actions.appendChild(btnCopy);
    actions.appendChild(btnClose);

    h.appendChild(title);
    h.appendChild(actions);

    meta = document.createElement('div');
    meta.style.cssText='font-size:12px;opacity:0.85;margin:6px 0 10px 0;line-height:1.35;';
    meta.textContent = '';

    pre = document.createElement('pre');
    pre.style.cssText = [
      'white-space:pre-wrap','word-break:break-word','font-size:12px','line-height:1.35',
      'margin:0','padding:12px','border-radius:12px','background:rgba(0,0,0,0.35)',
      'border:1px solid rgba(255,255,255,0.12)','max-height:72vh','overflow:auto'
    ].join(';');

    card.appendChild(h);
    card.appendChild(meta);
    card.appendChild(pre);
    overlay.appendChild(card);
    document.documentElement.appendChild(overlay);

    btnClose.addEventListener('click', function(){ overlay.style.display='none'; });
    btnCopy.addEventListener('click', async function(){
      try{
        var text = buildText();
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          var ta = document.createElement('textarea');
          ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
        }
        btnCopy.textContent='Copied';
        setTimeout(function(){ btnCopy.textContent='Copy'; }, 900);
      }catch(e){
        btnCopy.textContent='Copy failed';
        setTimeout(function(){ btnCopy.textContent='Copy'; }, 1200);
      }
    });
  }

  function nowIso(){
    try { return new Date().toISOString(); } catch(e){ return ''+Date.now(); }
  }

  function buildText(){
    var ua = navigator.userAgent || '';
    var href = location.href || '';
    var head = [
      'time: ' + nowIso(),
      'url: ' + href,
      'ua: ' + ua
    ].join('\n');
    return head + '\n\n' + logs.join('\n');
  }

  function show(kind, message, source, lineno, colno, stack){
    ensureOverlay();
    var ua = navigator.userAgent || '';
    meta.textContent = 'URL: ' + (location.href||'') + '   |   UA: ' + ua;
    var lines = [];
    lines.push('['+kind+'] ' + nowIso());
    if (message) lines.push('message: ' + message);
    if (source) lines.push('source: ' + source + (lineno!=null ? (':' + lineno + (colno!=null ? (':' + colno) : '')) : ''));
    if (stack) lines.push('stack:\n' + stack);
    lines.push('----');
    var block = lines.join('\n');
    logs.push(block);
    pre.textContent = buildText();
    overlay.style.display='block';
  }

  window.addEventListener('error', function(ev){
    try{
      var err = ev.error;
      show(
        'error',
        ev.message || (err && err.message) || String(ev),
        ev.filename,
        ev.lineno,
        ev.colno,
        err && err.stack
      );
    }catch(e){}
  });

  window.addEventListener('unhandledrejection', function(ev){
    try{
      var reason = ev.reason;
      var msg = (reason && reason.message) ? reason.message : (typeof reason === 'string' ? reason : JSON.stringify(reason));
      var stack = reason && reason.stack;
      show('unhandledrejection', msg, '', null, null, stack);
    }catch(e){}
  });

  // Also mirror console.error into the overlay log
  try{
    var origErr = console.error;
    console.error = function(){
      try{
        var args = Array.prototype.slice.call(arguments);
        var msg = args.map(function(a){
          if (a instanceof Error) return (a.message + '\n' + (a.stack||''));
          if (typeof a === 'object') { try { return JSON.stringify(a); } catch(e){ return String(a); } }
          return String(a);
        }).join(' ');
        logs.push('[console.error] ' + nowIso() + '\n' + msg + '\n----');
        if (overlay && overlay.style.display==='block') pre.textContent = buildText();
      }catch(e){}
      return origErr.apply(console, arguments);
    };
  }catch(e){}
})();
</script>

<script type="module">
    import { UNDO_SVG, REDO_SVG, GEAR_SVG, FOLDER_SVG } from "./scripts/ui/components/icons.js";
    
    document.addEventListener('DOMContentLoaded', () => {
      const undoBtn = document.getElementById('undoBtn');
      const redoBtn = document.getElementById('redoBtn');
      const mainsettings = document.getElementById('mainsettings');
      const settingsBtn = document.getElementById('settingsBtn');
      
      if (undoBtn) undoBtn.innerHTML = UNDO_SVG;
      if (redoBtn) redoBtn.innerHTML = REDO_SVG;
      if (redoBtn) redoBtn.innerHTML = REDO_SVG;
      if (mainsettings) mainsettings.innerHTML = GEAR_SVG;
      if (settingsBtn) settingsBtn.innerHTML = FOLDER_SVG;
    });
  </script>

  <div id="welcomeOverlay" class="ff-esc-disabled ff-popup-overlay ff-welcome-overlay ff-overlay-center hidden">
    <div class="ff-welcome-panel">
      <div class="welcome-logo">
        <img src="./images/logo.png" alt="FinFlow Logo" class="welcome-logo-img" />
      </div>
      <p class="ff-welcome-tagline" data-i18n="wizard.welcome.tagline"></p>
      <button id="welcomeStartBtn" class="ff-btn ff-btn--primary" data-i18n="wizard.welcome.button"></button>
    </div>
  </div>

  <!--
    Sticky top-area: header + nav-pill must stay in place while
    the year overview + month cards can be vertically swiped.
  -->
  <div id="ffTopArea" class="ff-top-area">

  <header style="position: relative; padding: calc(env(safe-area-inset-top, 0px) + 10px) 16px 10px 16px;">
    <h1 data-i18n="common.app_title" style="margin: 0; padding-right: 45px;"></h1>
    <button id="mainsettings" class="icon-btn" type="button" style="position: absolute; right: 16px; top: calc(env(safe-area-inset-top, 0px) + 10px); background: none; border: none; cursor: pointer;"></button>
  </header>

  <div id="devPanel" class="dev-panel" style="display:none;">
    <button id="devExportBtn" data-i18n="common.export_data"></button>
    <button id="devImportBtn" data-i18n="common.import_data"></button>
    <input type="file" id="importFileInput" accept="application/json" style="display:none;">
  </div>

  <div id="yearNavPill" class="nav-pill">
    <div id="navZoneLeft" class="nav-zone">
        <button id="prevYearBtn" class="year-arrow">◀</button>
    </div>

    <div id="navZoneCenter" class="nav-zone">
        <span id="currentYear">2025</span>
        <button id="undoBtn" class="icon-btn nav-icon-btn" type="button" disabled aria-disabled="true"></button>
        <button id="redoBtn" class="icon-btn nav-icon-btn" type="button" disabled aria-disabled="true"></button>
        <button id="scenariosBtn" class="icon-btn nav-icon-btn" type="button"></button>
        <button id="settingsBtn" class="icon-btn" type="button"></button>
    </div>

    <div id="navZoneRight" class="nav-zone">
        <button id="nextYearBtn" class="year-arrow">▶</button>
    </div>
  </div>

  </div>

  <!-- Scroll container: ONLY this area should scroll on vertical swipe -->
  <main id="ffScrollArea" class="ff-scroll-area">

  <div class="table-container ff-year-cards-container">
    <table class="year-grid ff-year-cards-table"> 
      <thead>
        <tr>
          <th data-i18n="table.headers.month"></th>
          <th data-i18n="table.headers.income"></th>
          <th data-i18n="table.headers.expense"></th>
          <th class="saving-cell" data-i18n="table.headers.savings"></th>
          <th data-i18n="table.headers.bank_balance"></th> 
          <th data-i18n="table.headers.savings_balance"></th> 
        </tr>
      </thead>
      <tbody id="yearTableBody"></tbody>
      <tfoot>
        <tr id="yearTotalRow"></tr> 
      </tfoot>
    </table>
  </div>

  </main>

  <div id="setupOverlay" class="ff-popup-overlay ff-popup-overlay--wizard" style="display:none;">
    <div id="setupSheet" class="ff-popup ff-popup--wizard ff-popup--beginsaldo">
      <div class="ff-popup__header">
        <h2 id="setupTitle" class="ff-popup__title" data-i18n="wizard.steps.balance_title"></h2>
      </div>
      <div class="ff-popup__body">
        <label class="ff-field ff-field--full">
          <span class="ff-field__label" data-i18n="common.bank_account"></span>
          <input id="setupBankInput" type="number" inputmode="decimal" step="0.01" min="0" class="ff-input ff-input--number ff-input--beginsaldo" />
        </label>
        <p class="ff-popup__hint" data-i18n="wizard.steps.balance_desc"></p>
      </div>
      <div class="ff-popup__footer">
        <button type="button" id="setupCancelBtn" class="ff-btn ff-btn--secondary" data-i18n="common.cancel"></button>
        <button type="button" id="setupSaveBtn" class="ff-btn ff-btn--primary" data-i18n="common.save"></button>
      </div>
    </div>
  </div>

  <div id="sheetOverlay" class="ff-popup-overlay" style="display: none;">
    <div id="sheetForm"></div>
  </div>

  <script type="module" src="scripts/main.js"></script>

  <script>
    document.getElementById("mainsettings").onclick = () => {
      const p = document.getElementById("devPanel");
      p.style.display = (p.style.display === "none" || p.style.display === "") ? "block" : "none";
    };
  </script>
</body>
</html>