<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>FinFlow</title>
  <link rel="stylesheet" href="app.css" />
  <link rel="stylesheet" href="styles/components/nav.css" />
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#000000" />
  <link rel="apple-touch-icon" sizes="180x180" href="./images/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="icon" type="image/png" sizes="192x192" href="./images/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./images/icon-512.png" />
</head>

<body>
  <script type="module">
    import { UNDO_SVG, REDO_SVG, GEAR_SVG, FOLDER_SVG } from "./scripts/ui/components/icons.js";
    
    document.addEventListener('DOMContentLoaded', () => {
      const undoBtn = document.getElementById('undoBtn');
      const redoBtn = document.getElementById('redoBtn');
      const mainsettings = document.getElementById('mainsettings');
      const settingsBtn = document.getElementById('settingsBtn');
      
      if (undoBtn) undoBtn.innerHTML = UNDO_SVG;
      if (redoBtn) redoBtn.innerHTML = REDO_SVG;
      if (redoBtn) redoBtn.innerHTML = REDO_SVG;
      if (mainsettings) mainsettings.innerHTML = GEAR_SVG;
      if (settingsBtn) settingsBtn.innerHTML = FOLDER_SVG;
    });
  </script>

  <div id="welcomeOverlay" class="ff-esc-disabled ff-popup-overlay ff-welcome-overlay ff-overlay-center hidden">
    <div class="ff-welcome-panel">
      <div class="welcome-logo">
        <img src="./images/logo.png" alt="FinFlow Logo" class="welcome-logo-img" />
      </div>
      <p class="ff-welcome-tagline" data-i18n="wizard.welcome.tagline"></p>
      <button id="welcomeStartBtn" class="ff-btn ff-btn--primary" data-i18n="wizard.welcome.button"></button>
    </div>
  </div>

  <!--
    Sticky top-area: header + nav-pill must stay in place while
    the year overview + month cards can be vertically swiped.
  -->
  <div id="ffTopArea" class="ff-top-area">

  <header style="position: relative; padding: calc(env(safe-area-inset-top, 0px) + 10px) 16px 10px 16px;">
    <h1 data-i18n="common.app_title" style="margin: 0; padding-right: 45px;"></h1>
    <button id="mainsettings" class="icon-btn" type="button" style="position: absolute; right: 16px; top: calc(env(safe-area-inset-top, 0px) + 10px); background: none; border: none; cursor: pointer;"></button>
  </header>

  <div id="devPanel" class="dev-panel" style="display:none;">
    <button id="devExportBtn" data-i18n="common.export_data"></button>
    <button id="devImportBtn" data-i18n="common.import_data"></button>
    <input type="file" id="importFileInput" accept="application/json" style="display:none;">
  </div>

  <div id="yearNavPill" class="nav-pill">
    <div id="navZoneLeft" class="nav-zone">
        <button id="prevYearBtn" class="year-arrow">◀</button>
    </div>

    <div id="navZoneCenter" class="nav-zone">
        <span id="currentYear">2025</span>
        <button id="undoBtn" class="icon-btn nav-icon-btn" type="button" disabled aria-disabled="true"></button>
        <button id="redoBtn" class="icon-btn nav-icon-btn" type="button" disabled aria-disabled="true"></button>
        <button id="scenariosBtn" class="icon-btn nav-icon-btn" type="button"></button>
        <button id="settingsBtn" class="icon-btn" type="button"></button>
    </div>

    <div id="navZoneRight" class="nav-zone">
        <button id="nextYearBtn" class="year-arrow">▶</button>
    </div>
  </div>

  </div>

  <!-- Scroll container: ONLY this area should scroll on vertical swipe -->
  <main id="ffScrollArea" class="ff-scroll-area">

  <div class="table-container ff-year-cards-container">
    <table class="year-grid ff-year-cards-table"> 
      <thead>
        <tr>
          <th data-i18n="table.headers.month"></th>
          <th data-i18n="table.headers.income"></th>
          <th data-i18n="table.headers.expense"></th>
          <th class="saving-cell" data-i18n="table.headers.savings"></th>
          <th data-i18n="table.headers.bank_balance"></th> 
          <th data-i18n="table.headers.savings_balance"></th> 
        </tr>
      </thead>
      <tbody id="yearTableBody"></tbody>
      <tfoot>
        <tr id="yearTotalRow"></tr> 
      </tfoot>
    </table>
  </div>

  </main>

  <div id="setupOverlay" class="ff-popup-overlay ff-popup-overlay--wizard" style="display:none;">
    <div id="setupSheet" class="ff-popup ff-popup--wizard ff-popup--beginsaldo">
      <div class="ff-popup__header">
        <h2 id="setupTitle" class="ff-popup__title" data-i18n="wizard.steps.balance_title"></h2>
      </div>
      <div class="ff-popup__body">
        <label class="ff-field ff-field--full">
          <span class="ff-field__label" data-i18n="common.bank_account"></span>
          <input id="setupBankInput" type="number" inputmode="decimal" step="0.01" min="0" class="ff-input ff-input--number ff-input--beginsaldo" />
        </label>
        <p class="ff-popup__hint" data-i18n="wizard.steps.balance_desc"></p>
      </div>
      <div class="ff-popup__footer">
        <button type="button" id="setupCancelBtn" class="ff-btn ff-btn--secondary" data-i18n="common.cancel"></button>
        <button type="button" id="setupSaveBtn" class="ff-btn ff-btn--primary" data-i18n="common.save"></button>
      </div>
    </div>
  </div>

  <div id="sheetOverlay" class="ff-popup-overlay" style="display: none;">
    <div id="sheetForm"></div>
  </div>

  

  <script>
    document.getElementById("mainsettings").onclick = () => {
      const p = document.getElementById("devPanel");
      p.style.display = (p.style.display === "none" || p.style.display === "") ? "block" : "none";
    };
  </script>

<script type="module">
(() => {
  const BUILD = "20260217-225408";
  const ENTRY = new URL("./scripts/main.js", location.href).href;

  const overlay = document.createElement("div");
  overlay.id = "ffBootDiag";
  overlay.style.cssText = [
    "position:fixed","inset:0","z-index:2147483647",
    "background:rgba(0,0,0,0.92)","color:#fff",
    "font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif",
    "padding:14px","overflow:auto"
  ].join(";");
  overlay.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
      <div style="font-weight:700">FinFlow boot diag</div>
      <div style="opacity:.7">build $20260217-225408</div>
      <div style="margin-left:auto;opacity:.7;font-size:12px">${location.href}</div>
    </div>
    <div id="ffBootDiagStatus" style="opacity:.85;margin-bottom:10px">Checking module graph…</div>
    <pre id="ffBootDiagOut" style="white-space:pre-wrap;word-break:break-word;background:rgba(255,255,255,0.06);padding:10px;border-radius:10px"></pre>
    <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
      <button id="ffBootDiagCopy" style="padding:10px 12px;border-radius:10px;border:0;font-weight:700">Copy</button>
      <button id="ffBootDiagHide" style="padding:10px 12px;border-radius:10px;border:0;opacity:.85">Hide</button>
      <div style="margin-left:auto;opacity:.7;font-size:12px">If everything is OK, this screen will disappear.</div>
    </div>
  `;
  document.documentElement.appendChild(overlay);

  const outEl = overlay.querySelector("#ffBootDiagOut");
  const statusEl = overlay.querySelector("#ffBootDiagStatus");
  const copyBtn = overlay.querySelector("#ffBootDiagCopy");
  const hideBtn = overlay.querySelector("#ffBootDiagHide");

  const report = {
    title: "FinFlow module graph check",
    build: BUILD,
    href: location.href,
    ua: navigator.userAgent,
    entry: ENTRY,
    checked: [],
    problems: [],
  };

  const log = (obj) => {
    try {
      outEl.textContent = JSON.stringify(obj, null, 2);
    } catch (e) {
      outEl.textContent = String(obj);
    }
  };
  log(report);

  copyBtn.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(outEl.textContent || "");
      statusEl.textContent = "Copied to clipboard.";
    } catch {
      statusEl.textContent = "Copy failed. Select text manually.";
    }
  });
  hideBtn.addEventListener("click", () => {
    overlay.style.display = "none";
  });

  const importRegexes = [
    /\bimport\s+[^;]*?\sfrom\s*["']([^"']+)["']/g,     // static
    /\bimport\s*\(\s*["']([^"']+)["']\s*\)/g          // dynamic with literal
  ];

  function extractSpecs(srcText) {
    const specs = new Set();
    for (const rx of importRegexes) {
      rx.lastIndex = 0;
      let m;
      while ((m = rx.exec(srcText))) {
        const spec = (m[1] || "").trim();
        if (!spec) continue;
        if (spec.startsWith(".") ) specs.add(spec);
      }
    }
    return Array.from(specs);
  }

  async function fetchModule(url) {
    let res, text = "";
    try {
      res = await fetch(url, { cache: "no-store" });
      const ct = res.headers.get("content-type") || "";
      // Only read body for JS-like responses; still read some for diagnostics
      text = await res.text();
      return {
        url,
        ok: res.ok,
        status: res.status,
        contentType: ct,
        head: text.slice(0, 160),
        text
      };
    } catch (e) {
      return {
        url,
        ok: false,
        status: 0,
        contentType: "",
        head: "",
        error: { name: e?.name, message: e?.message }
      };
    }
  }

  function isHtml(ct, head) {
    if ((ct || "").includes("text/html")) return true;
    const h = (head || "").trim().toLowerCase();
    return h.startsWith("<!doctype") || h.startsWith("<html");
  }

  (async () => {
    const q = [ENTRY];
    const seen = new Set();
    while (q.length) {
      const url = q.shift();
      if (seen.has(url)) continue;
      seen.add(url);

      statusEl.textContent = "Fetching " + url.replace(location.origin, "");
      const info = await fetchModule(url);

      const entry = {
        url: info.url,
        ok: info.ok,
        status: info.status,
        contentType: info.contentType,
        head: info.head
      };
      report.checked.push(entry);

      if (!info.ok) {
        report.problems.push({ type: "fetch-failed", ...entry, error: info.error || null });
        log(report);
        continue;
      }
      if (isHtml(info.contentType, info.head)) {
        report.problems.push({ type: "html-returned", ...entry });
        log(report);
        continue;
      }

      // parse imports
      const specs = extractSpecs(info.text || "");
      for (const spec of specs) {
        const depUrl = new URL(spec, url).href;
        if (!seen.has(depUrl)) q.push(depUrl);
      }

      // keep UI updated
      log(report);
      // safety cap
      if (report.checked.length > 600) {
        report.problems.push({ type: "cap", message: "Too many modules; stopping at 600." });
        break;
      }
    }

    if (report.problems.length) {
      statusEl.textContent = "Problems found. Paste this JSON back into chat.";
      log(report);
      return;
    }

    statusEl.textContent = "All modules fetched OK. Importing entry…";
    try {
      await import(ENTRY + "?v=" + BUILD);
      overlay.remove();
    } catch (e) {
      report.title = "Entry import failed after graph OK";
      report.error = {
        name: e?.name,
        message: e?.message,
        stack: e?.stack
      };
      statusEl.textContent = "Import failed. Paste JSON back into chat.";
      log(report);
    }
  })();
})();
</script>

</body>
</html>